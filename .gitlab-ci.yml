stages:
  - test
  - build
  - analyze
  - report

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Tests del Backend
test:backend:
  stage: test
  image: python:3.11-slim
  before_script:
    - cd backend
    - pip install -r requirements.txt
  script:
    - pytest -v --tb=short
    - echo "Tests del backend completados"
  artifacts:
    reports:
      junit: backend/report.xml
    expire_in: 1 week

# Tests del Frontend (placeholder)
test:frontend:
  stage: test
  image: node:18-alpine
  before_script:
    - cd frontend
    - npm install
  script:
    - npm test
    - echo "Tests del frontend completados"

# Análisis Estático - Flake8
analyze:flake8:
  stage: analyze
  image: python:3.11-slim
  before_script:
    - pip install flake8
  script:
    - cd backend
    - flake8 . --count --statistics --output-file=flake8-report.txt || true
    - cat flake8-report.txt
    - echo "Análisis estático completado"
  artifacts:
    paths:
      - backend/flake8-report.txt
    expire_in: 1 week
  allow_failure: true

# Build Backend Docker Image
build:backend:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd backend
    - docker build -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA .
    - docker build -t $CI_REGISTRY_IMAGE/backend:latest .
    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/backend:latest
    - echo "Imagen backend construida y subida"
  only:
    - main
    - develop

# Build Frontend Docker Image
build:frontend:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd frontend
    - docker build -t $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA .
    - docker build -t $CI_REGISTRY_IMAGE/frontend:latest .
    - docker push $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/frontend:latest
    - echo "Imagen frontend construida y subida"
  only:
    - main
    - develop

# Generar Reporte
report:summary:
  stage: report
  image: alpine:latest
  script:
    - echo "===== Reporte del Pipeline CI/CD ====="
    - echo "Commit: $CI_COMMIT_SHORT_SHA"
    - echo "Rama: $CI_COMMIT_REF_NAME"
    - echo "Autor: $CI_COMMIT_AUTHOR"
    - echo "Pipeline ID: $CI_PIPELINE_ID"
    - echo "Fecha: $(date)"
    - echo "======================================"
    - echo "Todas las etapas completadas exitosamente"
    - echo "1. Tests ejecutados ✓"
    - echo "2. Imágenes Docker construidas ✓"
    - echo "3. Análisis estático realizado ✓"
    - echo "======================================"
  artifacts:
    paths:
      - pipeline-report.txt
    expire_in: 1 week